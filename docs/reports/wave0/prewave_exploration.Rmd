---
title: 'Exploration of media and trust before the campaign'
author: "Wouter van Atteveldt, Nel Ruigrok, Mariken van der Velden"
permalink: reports/prewave_exploration.html
output: 
  md_document:
    toc: yes
    preserve_yaml: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo=F, fig.path='', fig.width = 10)
library(printr)
options(digits = 2)
```


```{r "Read Data"}
library(here)
library(tidyverse)
source(here("src/lib/data.R"))
d_raw <- read_csv(here("data/intermediate/VUElectionPanel2021_wave0.csv"))
resp = extract_wide(d_raw)
long = extract_long(d_raw)
long_vote = resp %>% select(iisID, vote) %>% inner_join(long)
theme_nrc = function(...) ggthemes::theme_hc(...) + theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.title.x=element_blank(), axis.title.y=element_blank())
```

# Current  Vote Intention

```{r eval=F}
library(igraph)
resp
ntot = votes %>% filter(A2 != "Weet niet", E1 != "Weet niet") %>% nrow()
gdf = votes %>% filter(A2 != "Weet niet", E1 != "Weet niet") %>% 
  group_by(A2, E1) %>% summarize(n=n()) %>% na.omit() %>% filter(A2 != E1)

gd = full_join(gdf, gdf, by=c("A2"="E1", "E1"="A2")) %>% replace_na(list("n.x"=0, "n.y"=0)) %>% mutate(n=n.x - n.y, zetels=n/ntot * 150) %>% filter(n>0)
g = gd %>% select(E1, A2, n, zetels) %>% filter(n>5) %>% graph_from_data_frame()

data$netwerk_veranderingen = gd

E(g)$width = 1+E(g)$n/10 
E(g)$label = round(E(g)$zetels, 1)
E(g)$arrow.size=E(g)$width/2

plot(g)
```


## Demographics

## Media Use by Vote Intention


```{r aux}
# Overall ordering of parties by institutional trust
parties = long_vote %>% filter(variable=="F2") %>% group_by(vote) %>% 
  summarize(value=mean(value)) %>% arrange(value) %>% pull(vote)
parties = c("Niet", "Anders", setdiff(parties, c("Niet", "Anders")), "Gemiddeld")
n_party = resp %>% group_by(vote) %>% summarize(ntot=n()) %>% na.omit()
ntotal = sum(n_party$ntot)
add_zeroes= function(x) x %>% pivot_wider(values_fill=0) %>% pivot_longer(-vote)

# Helper functions
create_table = function(long_data, compute_perc=FALSE) {
  d = long_data %>% group_by(vote, name) %>% summarize(n=n(), value=mean(value, na.rm=T)) %>%
    inner_join(n_party) %>% mutate(value=if (compute_perc) n/ntot*100 else value)
  total = long_data %>% group_by(name) %>% summarize(n=n(), value=mean(value, na.rm=T)) %>% 
    mutate(value=if (compute_perc) n/ntotal*100 else value) %>% 
    add_column(vote="Gemiddeld") 
  bind_rows(d, total) %>% select(vote, name, value) %>% 
    ungroup() %>% add_zeroes() %>% 
    mutate(
      vote = factor(vote, levels=parties),
      name=fct_reorder(name, value, mean)
    )
}
color_table_plot = function(data, title, subtitle=NULL, digits=0, print=T, export=T) {
  plot = ggplot(data, aes(x=vote, y=name, label=round(value, digits = digits), fill=value)) +
    geom_tile()+ geom_text()+
    ggtitle(title, subtitle)  + 
    scale_fill_gradient(low="white", high="#3182bd", guide=F) +
    theme_nrc()
  if (print) print(plot)
  if (export) data %>% 
    pivot_wider(names_from="vote", names_sort=T) %>% 
    export_data(title) %>% str_c("Download data: ", .) %>% cat()
  if (print) invisible(plot) else plot
}
```

```{r wave0-media-party, results='asis'}
d = long_vote %>% filter(variable=="I1") %>% create_table()
color_table_plot(d, "Wave 0: Stemintentie en mediagebruik", digits=1, export=F)
```

## Use of particular channels {.tabset}

```{r wave0-media-party-specific, results='asis'}
pct_variables = c(I2="Newspapers", I3="TV", I4="Online", I5="Social", I7="Apps")
for (var in names(pct_variables)) {
  cat(str_c("\n\n### Use of ", pct_variables[[var]], "\n\n"))
  label = paste("Wave 0: Vote intention and news: ", pct_variables[[var]])
  message(paste(var, label))
  d = long_vote %>% filter(variable==var, name != "Other, namely:", value != 0) %>% create_table(compute_perc = T)
  color_table_plot(data=d, title = label, subtitle = "(Percentage of voters for that party; multiple options possible)")
}
```

# Trust

## Trust in Media

```{r wave0-trust-media, results='asis'}
d = long_vote %>% filter(variable=="I8") %>% create_table()
color_table_plot(d, "Wave 0: Trust in Media", subtitle="(Grade from 0=low tot 10=high)", digits=1)
```

## Trust in Institutions

```{r wave0-trust-institution, results='asis'}
d = long_vote %>% filter(variable=="F2") %>% create_table()
color_table_plot(d, "Wave 0: Trust in Instituties", subtitle="(Grade from 0=low tot 10=high)", digits=1)
```

```{r wave0-trust-group, results='asis'}
d = long_vote %>% filter(variable=="F2") %>%
  mutate(name=case_when(
    name == "Science" ~ "Wetenschap",
    name == "The justice system" ~ "Rechtspraak",
    name == "Dutch democracy" ~ "Democratie",
    name == "Journalism" ~ "Journalistiek",
    name %in% c("Banks", "Big corporations") ~ "Bedrijfsleven",
    T ~ "Politiek"
  ))%>% create_table()
color_table_plot(d, "Wave 0: Trust in Institutions (grouped)", 
                    subtitle="(Grade from 0=low tot 10=high)", digits=1)
```

## Trust in democracy

```{r wave0-democracy, results='asis'}
d = long_vote %>% filter(variable=="F2", name == "Dutch democracy") %>% mutate(ok=value>5.5)
x = d %>% group_by(ok, value) %>% summarize(n=n()) %>% ungroup() %>% mutate(perc=n/sum(n)*100)
ggplot(x) + geom_col(aes(x=value, y=perc, fill=ok)) + scale_x_continuous(breaks=0:10) + 
  scale_fill_manual(values=c(scales::muted("red"), scales::muted("green")), guide=F) +
  theme_nrc() + ggtitle("Rapportcijfer voor Democratie")
```

```{r wave0-democracy2, results='asis'}
dt = d %>% group_by(vote, value) %>% summarize(n=n()) %>% mutate(perc=n/sum(n)*100)

total = d %>% group_by(value) %>% summarize(n=n()) %>% mutate(perc=n/sum(n) * 100) %>% 
    add_column(vote="Gemiddeld") 
dt = bind_rows(dt, total) %>% select(vote, name=value, value=perc) %>% 
  ungroup() %>% add_zeroes() %>% 
  mutate(vote = factor(vote, levels=parties),
         name=factor(as.character(name), levels=as.character(0:10)))

color_table_plot(dt, "Wave 0: Trust in democracy", subtitle="(Percentage of voters for a party)")
```
